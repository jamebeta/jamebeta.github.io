<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Vue全局配置WebSocket</title>
      <link href="/2023/05/08/Vue%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AEWebSocket/"/>
      <url>/2023/05/08/Vue%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AEWebSocket/</url>
      
        <content type="html"><![CDATA[<blockquote><p>服务端可以主动向客户端推送数据，浏览器和服务器只需要完成一次握手，两者之间就可以创建持久性的连接，并进行双向数据传输</p></blockquote><h3 id="创建文件utils-global-js，且在main中引用"><a href="#创建文件utils-global-js，且在main中引用" class="headerlink" title="创建文件utils/global.js，且在main中引用"></a>创建文件utils/global.js，且在main中引用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// global.js 文件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">ws</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">setWs</span>: <span class="keyword">function</span>(<span class="params">newWs</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ws</span> = newWs</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vue2 main.js 文件</span></span><br><span class="line"><span class="keyword">import</span> <span class="variable language_">global</span> <span class="keyword">from</span> <span class="string">&#x27;./xx/global.js&#x27;</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">global</span> = <span class="variable language_">global</span> <span class="comment">//vue2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// vue3 main.js 文件</span></span><br><span class="line"><span class="keyword">import</span> <span class="variable language_">global</span> <span class="keyword">from</span> <span class="string">&#x27;./xx/global.js&#x27;</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line">app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">global</span> = <span class="variable language_">global</span></span><br></pre></td></tr></table></figure><h3 id="在合适地方进行初始化"><a href="#在合适地方进行初始化" class="headerlink" title="在合适地方进行初始化"></a>在合适地方进行初始化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">localSocket</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">  <span class="keyword">let</span> that = <span class="variable language_">this</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;WebSocket&quot;</span> <span class="keyword">in</span> <span class="variable language_">window</span>) &#123;</span><br><span class="line">      that.<span class="property">ws</span> = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://localhost:8081/xxx);</span></span><br><span class="line"><span class="string">      that.global.setWs(that.ws);</span></span><br><span class="line"><span class="string">      that.ws.onopen = function () &#123;</span></span><br><span class="line"><span class="string">          console.log(&#x27;websocket连接成功&#x27;);</span></span><br><span class="line"><span class="string">      &#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      that.ws.onclose = function () &#123;</span></span><br><span class="line"><span class="string">          // 关闭 websocket</span></span><br><span class="line"><span class="string">          console.log(&quot;</span>连接已关闭...<span class="string">&quot;);</span></span><br><span class="line"><span class="string">          //断线重新连接</span></span><br><span class="line"><span class="string">          // setTimeout(() =&gt; &#123;</span></span><br><span class="line"><span class="string">          //     that.localSocket();</span></span><br><span class="line"><span class="string">          // &#125;, 2000);</span></span><br><span class="line"><span class="string">      &#125;;</span></span><br><span class="line"><span class="string">  &#125; else &#123;</span></span><br><span class="line"><span class="string">      // 浏览器不支持 WebSocket</span></span><br><span class="line"><span class="string">      console.log(&quot;</span>您的浏览器不支持 <span class="title class_">WebSocket</span>!<span class="string">&quot;);</span></span><br><span class="line"><span class="string">      this.openNotificationWithIcon(&#x27;error&#x27;, &#x27;浏览器&#x27;, &#x27;您的浏览器不支持显示消息请更换&#x27;, 1, 1)</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="在Vue2中使用"><a href="#在Vue2中使用" class="headerlink" title="在Vue2中使用"></a>在Vue2中使用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">handdleMsg</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> that = <span class="variable language_">this</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(that.<span class="property">global</span>.<span class="property">ws</span>);</span><br><span class="line">            <span class="keyword">if</span> (that.<span class="property">global</span>.<span class="property">ws</span> &amp;&amp; that.<span class="property">global</span>.<span class="property">ws</span>.<span class="property">readyState</span> == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;发送信息&quot;</span>, <span class="variable language_">this</span>.<span class="property">data</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">content</span> = <span class="variable language_">this</span>.<span class="property">content</span></span><br><span class="line">                that.<span class="property">global</span>.<span class="property">ws</span>.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; ...<span class="variable language_">this</span>.<span class="property">data</span>, <span class="attr">t</span>: <span class="variable language_">this</span>.<span class="property">list</span>[<span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">t</span>].<span class="property">f</span> &#125;));</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">content</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">content</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            that.<span class="property">global</span>.<span class="property">ws</span>.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;收到服务器内容&quot;</span>, res);</span><br><span class="line">                <span class="keyword">let</span> obj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(res.<span class="property">data</span>)</span><br><span class="line">                <span class="keyword">let</span> i = <span class="number">0</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(obj);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; that.<span class="property">list</span>.<span class="property">length</span>; index++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (that.<span class="property">list</span>[index].<span class="property">f</span> === obj.<span class="property">t</span> || that.<span class="property">list</span>[index].<span class="property">f</span> === obj.<span class="property">f</span>) &#123;</span><br><span class="line">                        i = index</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                that.<span class="property">chats</span>[i].<span class="title function_">push</span>(obj)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h3 id="在Vue3中使用"><a href="#在Vue3中使用" class="headerlink" title="在Vue3中使用"></a>在Vue3中使用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, reactive, getCurrentInstance, computed &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">appContext</span>: &#123; <span class="attr">config</span>: &#123; <span class="attr">globalProperties</span>: <span class="variable language_">global</span> &#125; &#125; &#125; = <span class="title function_">getCurrentInstance</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handdleMsg</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> that = <span class="variable language_">global</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(that.<span class="property">global</span>.<span class="property">ws</span>);</span><br><span class="line">    <span class="keyword">if</span> (that.<span class="property">global</span>.<span class="property">ws</span> &amp;&amp; that.<span class="property">global</span>.<span class="property">ws</span>.<span class="property">readyState</span> == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;发送信息&quot;</span>, data.<span class="property">arr</span>);</span><br><span class="line">        that.<span class="property">global</span>.<span class="property">ws</span>.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; ...data.<span class="property">arr</span>, <span class="attr">t</span>: list.<span class="property">arr</span>[data.<span class="property">arr</span>.<span class="property">t</span>].<span class="property">t</span> &#125;));</span><br><span class="line">        data.<span class="property">arr</span>.<span class="property">content</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    that.<span class="property">global</span>.<span class="property">ws</span>.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;收到服务器内容&quot;</span>, res);</span><br><span class="line">        <span class="keyword">let</span> obj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(res.<span class="property">data</span>)</span><br><span class="line">        <span class="keyword">let</span> i = data.<span class="property">arr</span>.<span class="property">t</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; list.<span class="property">arr</span>.<span class="property">length</span>; index++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (list.<span class="property">arr</span>[index].<span class="property">t</span> === obj.<span class="property">t</span> || list.<span class="property">arr</span>[index].<span class="property">t</span> === obj.<span class="property">f</span>) &#123;</span><br><span class="line">                i = index</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        chats.<span class="property">arr</span>[i].<span class="title function_">push</span>(obj)</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vue </tag>
            
            <tag> WebSocket </tag>
            
            <tag> Js </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
